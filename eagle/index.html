<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eagle 风格素材管理器 · 纯 HTML 版</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --muted:#6b7280; --text:#111827; --border:#e5e7eb;
      --indigo:#6366f1; --fuchsia:#a855f7; --ring:#818cf8; --amber:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto; background:var(--bg); color:var(--text); display:flex}
    /* Sidebar */
    aside{width:260px; background:#fff; border-right:1px solid var(--border); padding:16px; display:flex; flex-direction:column; gap:12px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; background:linear-gradient(90deg,var(--indigo),var(--fuchsia)); -webkit-background-clip:text; background-clip:text; color:transparent}
    .chip{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border:1px solid var(--border); border-radius:999px; font-size:12px; color:#475569; background:#fff; cursor:pointer}
    .chip.active{background:#eef2ff; color:#4338ca; border-color:#c7d2fe}
    .section-title{font-size:12px; color:#94a3b8; text-transform:uppercase; letter-spacing:.06em; margin-top:6px}
    .folder{width:100%; text-align:left; padding:8px 10px; border-radius:10px; border:1px solid transparent; cursor:pointer; color:#334155}
    .folder:hover{background:#f8fafc}
    .folder.active{background:#eef2ff; color:#4338ca; border-color:#c7d2fe}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:#fff; cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--indigo),var(--fuchsia)); color:#fff; border:none}
    .btn.destructive{background:#fee2e2; color:#b91c1c; border-color:#fecaca}
    .btn.ghost{background:transparent}

    /* Topbar */
    header{position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid var(--border); padding:10px 14px; display:flex; align-items:center; gap:10px}
    .search{flex:1; position:relative}
    .search input{width:100%; padding:10px 36px 10px 36px; border:1px solid var(--border); border-radius:12px; outline:none}
    .search .icon{position:absolute; left:10px; top:50%; transform:translateY(-50%); color:#94a3b8}

    /* Main */
    .main{flex:1; display:flex; flex-direction:column}
    .grid{padding:16px; columns:1; column-gap:16px}
    @media(min-width:700px){.grid{columns:2}}
    @media(min-width:1100px){.grid{columns:3}}
    @media(min-width:1400px){.grid{columns:4}}

    .card{break-inside:avoid; background:var(--card); border-radius:16px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,.06); margin:0 0 16px; position:relative; border:1px solid var(--border)}
    .card img{width:100%; display:block}
    .meta{padding:10px 12px}
    .title{font-weight:600; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .row{display:flex; justify-content:space-between; align-items:center; margin-top:8px}
    .dot{width:16px; height:16px; border-radius:50%; border:1px solid #fff; box-shadow:0 0 0 1px var(--border)}
    .star{position:absolute; top:8px; right:8px; background:#fff; border-radius:999px; padding:6px; box-shadow:0 2px 6px rgba(0,0,0,.12); cursor:pointer}
    .select{position:absolute; bottom:8px; left:8px; background:#fff; border:1px solid var(--border); border-radius:8px; padding:4px 8px; font-size:12px; cursor:pointer}
    .selected{outline:2px solid var(--ring)}

    /* Inspector */
    .inspector{position:fixed; right:0; top:0; height:100%; width:320px; background:#fff; border-left:1px solid var(--border); transform:translateX(100%); transition:transform .25s; display:flex; flex-direction:column; z-index:50}
    .inspector.open{transform:translateX(0)}
    .inspector .img-wrap{padding:12px; border-bottom:1px solid var(--border)}
    .inspector .img-wrap img{width:100%; border-radius:12px}
    .inspector .content{padding:12px; display:flex; flex-direction:column; gap:10px}
    .field label{font-size:12px; color:#64748b; display:block; margin-bottom:6px}
    .field input,.field textarea,.field select{width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; outline:none}
    .row-wrap{display:flex; gap:8px}

    /* Drag overlay */
    .overlay{position:fixed; inset:0; background:rgba(99,102,241,.08); border:4px dashed rgba(99,102,241,.5); display:grid; place-items:center; font-weight:700; color:#4338ca; z-index:40; pointer-events:none; opacity:0; transition:opacity .2s}
    .overlay.show{opacity:1}

    /* Empty */
    .empty{display:grid; place-items:center; height:220px; color:#94a3b8}

    /* Footer small tips */
    .tips{padding:8px 12px; border-top:1px solid var(--border); color:#94a3b8; font-size:12px}
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside>
    <div class="brand">Eagle Lite</div>
    <div class="section-title">文件夹</div>
    <div id="folders"></div>
    <button class="btn" id="newFolder">+ 新建文件夹</button>

    <div class="section-title">标签</div>
    <div id="tags" style="display:flex; flex-wrap:wrap; gap:8px"></div>

    <div style="margin-top:auto"></div>
    <button class="btn" id="exportJson">备份导出</button>
    <label class="btn" style="margin-top:8px">
      <input type="file" id="importJson" accept="application/json" hidden>
      导入备份
    </label>
    <div class="tips">数据只保存在你的浏览器（localStorage）。</div>
  </aside>

  <!-- Main -->
  <div class="main">
    <header>
      <div class="search">
        <span class="icon">🔎</span>
        <input id="q" placeholder="搜索标题或标签…" />
      </div>
      <input type="file" id="file" accept="image/*" multiple hidden>
      <label for="file" class="btn">📤 上传</label>
      <div id="bulk" style="display:flex; gap:8px; margin-left:6px">
        <button class="btn" id="bulkTag">🏷️ 批量加标签</button>
        <button class="btn" id="bulkStar">⭐ 设为星标</button>
        <button class="btn destructive" id="bulkDel">🗑️ 删除所选</button>
        <button class="btn ghost" id="bulkClear">清空选择</button>
      </div>
    </header>

    <div id="grid" class="grid"></div>
    <div id="empty" class="empty" style="display:none">暂无素材，点击右上角“上传”或拖拽图片到页面</div>
  </div>

  <!-- Inspector -->
  <aside id="inspector" class="inspector" aria-hidden="true">
    <div class="img-wrap"><img id="insImg" alt="预览"></div>
    <div class="content">
      <div class="field">
        <label>标题</label>
        <input id="insTitle">
      </div>
      <div class="field">
        <label>标签（逗号分隔）</label>
        <input id="insTags">
      </div>
      <div class="field">
        <label>移动到文件夹</label>
        <select id="insFolder"></select>
      </div>
      <div class="field">
        <label>备注</label>
        <textarea id="insNotes" rows="4" placeholder="随手记录灵感…"></textarea>
      </div>
      <div class="field">
        <label>信息</label>
        <div id="insInfo" style="font-size:12px; color:#64748b"></div>
      </div>
      <div class="row-wrap">
        <button class="btn destructive" id="insDelete">🗑️ 删除</button>
        <button class="btn" id="insStar">⭐ 星标</button>
        <button class="btn" id="insClose" style="margin-left:auto">关闭</button>
      </div>
    </div>
  </aside>

  <div id="overlay" class="overlay">释放以上传图片</div>

  <script>
    // ===== Types =====
    /** Asset schema
     * { id, title, tags[], folder, starred, createdAt, dataUrl, w, h, avg, notes }
     */

    // ===== State =====
    const LS_ASSETS = 'eagle-lite:assets:html';
    const LS_FOLDERS = 'eagle-lite:folders:html';
    const LS_ACTIVE = 'eagle-lite:active-folder:html';

    let assets = readJSON(LS_ASSETS, []);
    let folders = readJSON(LS_FOLDERS, ['全部','未归类','灵感','UI','插画','摄影']);
    let activeFolder = localStorage.getItem(LS_ACTIVE) || '全部';
    let activeTag = null; // string | null
    let selection = new Set();

    // ===== Elements =====
    const elFolders = document.getElementById('folders');
    const elTags = document.getElementById('tags');
    const elGrid = document.getElementById('grid');
    const elEmpty = document.getElementById('empty');
    const elQ = document.getElementById('q');
    const elOverlay = document.getElementById('overlay');

    const elInspector = document.getElementById('inspector');
    const insImg = document.getElementById('insImg');
    const insTitle = document.getElementById('insTitle');
    const insTags = document.getElementById('insTags');
    const insFolder = document.getElementById('insFolder');
    const insNotes = document.getElementById('insNotes');
    const insInfo = document.getElementById('insInfo');

    // ===== Utils =====
    function uid(){ return (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2)); }
    function save(){ localStorage.setItem(LS_ASSETS, JSON.stringify(assets)); localStorage.setItem(LS_FOLDERS, JSON.stringify(folders)); localStorage.setItem(LS_ACTIVE, activeFolder); }
    function readJSON(key, fallback){ try{ const raw = localStorage.getItem(key); return raw? JSON.parse(raw): fallback; }catch{ return fallback } }
    function human(bytes){ const u=['B','KB','MB','GB']; let i=0,v=bytes; while(v>1024 && i<u.length-1){ v/=1024; i++; } return (i?v.toFixed(1):v|0)+u[i]; }
    function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(String(r.result)); r.onerror=rej; r.readAsDataURL(file); }); }
    function getImageSize(src){ return new Promise(res=>{ const i=new Image(); i.onload=()=>res({w:i.naturalWidth,h:i.naturalHeight}); i.src=src; }); }
    function averageColor(src){ return new Promise(resolve=>{ const img=new Image(); img.crossOrigin='anonymous'; img.onload=()=>{ const c=document.createElement('canvas'); const ctx=c.getContext('2d'); const w=c.width=64, h=c.height=64; ctx.drawImage(img,0,0,w,h); const d=ctx.getImageData(0,0,w,h).data; let r=0,g=0,b=0,n=0; for(let i=0;i<d.length;i+=4){ const a=d[i+3]; if(a===0) continue; r+=d[i]; g+=d[i+1]; b+=d[i+2]; n++; } if(!n) return resolve('#ddd'); r=Math.round(r/n); g=Math.round(g/n); b=Math.round(b/n); resolve('#'+[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('')); }; img.src=src; }); }

    // ===== Rendering =====
    function renderFolders(){
      elFolders.innerHTML='';
      folders.forEach(f=>{
        const btn=document.createElement('button');
        btn.className='folder'+(activeFolder===f?' active':'');
        btn.textContent=f; btn.onclick=()=>{ activeFolder=f; activeTag=null; save(); renderAll(); };
        elFolders.appendChild(btn);
      });
      // inspector folder options
      insFolder.innerHTML = folders.map(f=>`<option value="${f}">${f}</option>`).join('');
    }

    function allTags(){ const s=new Set(); assets.forEach(a=> (a.tags||[]).forEach(t=> s.add(t))); return Array.from(s).sort((a,b)=> a.localeCompare(b)); }

    function renderTags(){
      elTags.innerHTML='';
      const tags=allTags();
      if(!tags.length){ const d=document.createElement('div'); d.style.color='#94a3b8'; d.style.fontSize='12px'; d.textContent='暂无标签'; elTags.appendChild(d); return; }
      tags.forEach(t=>{
        const b=document.createElement('button'); b.className='chip'+(activeTag===t?' active':''); b.textContent='#'+t; b.onclick=()=>{ activeTag = activeTag===t? null : t; renderAll(); };
        elTags.appendChild(b);
      })
    }

    function filtered(){
      const q = elQ.value.trim().toLowerCase();
      return assets.filter(a=>{
        if(activeFolder && activeFolder!=='全部' && a.folder!==activeFolder) return false;
        if(activeTag && !(a.tags||[]).includes(activeTag)) return false;
        if(q){ const hay=(a.title||'').toLowerCase()+ ' ' + (a.tags||[]).join(' ').toLowerCase(); if(!hay.includes(q)) return false; }
        return true;
      }).sort((a,b)=> b.createdAt - a.createdAt);
    }

    function renderGrid(){
      const list = filtered();
      elGrid.innerHTML='';
      if(!list.length){ elEmpty.style.display='grid'; return; } else elEmpty.style.display='none';
      list.forEach(a=>{
        const card=document.createElement('div'); card.className='card'+(selection.has(a.id)?' selected':'');
        const img=new Image(); img.src=a.dataUrl; img.alt=a.title||''; img.loading='lazy'; img.onclick=()=> openInspector(a.id);
        const star=document.createElement('button'); star.className='star'; star.title=a.starred?'取消星标':'设为星标'; star.innerHTML=a.starred?'⭐':'☆'; star.onclick=(e)=>{ e.stopPropagation(); a.starred=!a.starred; save(); renderGrid(); };
        const sel=document.createElement('button'); sel.className='select'; sel.textContent=selection.has(a.id)?'已选择':'选择'; sel.onclick=(e)=>{ e.stopPropagation(); if(selection.has(a.id)) selection.delete(a.id); else selection.add(a.id); renderGrid(); };
        const meta=document.createElement('div'); meta.className='meta';
        const t=document.createElement('div'); t.className='title'; t.title=a.title||''; t.textContent=a.title||'未命名';
        const row=document.createElement('div'); row.className='row';
        const dot=document.createElement('span'); dot.className='dot'; dot.style.background=a.avg||'#e5e7eb';
        const info=document.createElement('span'); info.style.fontSize='12px'; info.style.color='#64748b'; info.textContent=(a.w&&a.h? `${a.w}×${a.h}`:'')
        row.appendChild(dot); row.appendChild(info);
        meta.appendChild(t); meta.appendChild(row);
        card.appendChild(img); card.appendChild(star); card.appendChild(sel); card.appendChild(meta);
        elGrid.appendChild(card);
      });
    }

    function renderAll(){ renderFolders(); renderTags(); renderGrid(); }

    // ===== File Handling =====
    async function handleFiles(files){
      const list = Array.from(files).filter(f=> f.type.startsWith('image/'));
      for(const f of list){
        const dataUrl = await fileToDataURL(f);
        const dim = await getImageSize(dataUrl);
        const avg = await averageColor(dataUrl);
        assets.unshift({ id: uid(), title: f.name.replace(/\.[^.]+$/, ''), tags: [], folder:'未归类', starred:false, createdAt: Date.now(), dataUrl, w: dim.w, h: dim.h, avg, notes:'' });
      }
      save(); renderAll();
    }

    document.getElementById('file').addEventListener('change', e=> handleFiles(e.target.files));

    // Drag & drop overlay
    let dragDepth = 0;
    window.addEventListener('dragenter', e=>{ e.preventDefault(); dragDepth++; elOverlay.classList.add('show'); });
    window.addEventListener('dragover', e=> e.preventDefault());
    window.addEventListener('dragleave', e=>{ dragDepth--; if(dragDepth<=0){ dragDepth=0; elOverlay.classList.remove('show'); } });
    window.addEventListener('drop', e=>{ e.preventDefault(); dragDepth=0; elOverlay.classList.remove('show'); if(e.dataTransfer?.files) handleFiles(e.dataTransfer.files); });

    // ===== Bulk actions =====
    document.getElementById('bulkTag').onclick=()=>{
      if(!selection.size) return alert('请先选择卡片');
      const input = prompt('为所选添加标签（多个用逗号）'); if(!input) return;
      const parts = input.split(',').map(s=>s.trim()).filter(Boolean);
      assets = assets.map(a=> selection.has(a.id)? { ...a, tags: Array.from(new Set([...(a.tags||[]), ...parts])) } : a);
      selection.clear(); save(); renderAll();
    };
    document.getElementById('bulkStar').onclick=()=>{
      if(!selection.size) return alert('请先选择卡片');
      assets = assets.map(a=> selection.has(a.id)? { ...a, starred:true } : a); selection.clear(); save(); renderAll();
    };
    document.getElementById('bulkDel').onclick=()=>{
      if(!selection.size) return alert('请先选择卡片');
      if(!confirm('确定删除所选素材？此操作不可撤销。')) return;
      assets = assets.filter(a=> !selection.has(a.id)); selection.clear(); save(); renderAll();
    };
    document.getElementById('bulkClear').onclick=()=>{ selection.clear(); renderGrid(); };

    // ===== Folders / Tags =====
    document.getElementById('newFolder').onclick=()=>{
      const name = prompt('新文件夹名称'); if(!name) return;
      if(folders.includes(name)) return alert('该文件夹已存在');
      folders.push(name); save(); renderAll();
    };

    // ===== Search =====
    elQ.addEventListener('input', ()=> renderGrid());

    // ===== Inspector =====
    let currentId = null;
    function openInspector(id){
      currentId = id; const a = assets.find(x=>x.id===id); if(!a) return;
      insImg.src = a.dataUrl; insTitle.value = a.title||''; insTags.value = (a.tags||[]).join(', ');
      insFolder.value = a.folder; insNotes.value = a.notes||'';
      insInfo.textContent = `${a.w}×${a.h}px · 创建于 ${new Date(a.createdAt).toLocaleString()}`;
      elInspector.classList.add('open'); elInspector.setAttribute('aria-hidden','false');
    }
    document.getElementById('insClose').onclick=()=>{ elInspector.classList.remove('open'); elInspector.setAttribute('aria-hidden','true'); };
    insTitle.addEventListener('blur',()=>{ const a=assets.find(x=>x.id===currentId); if(!a) return; a.title=insTitle.value.trim()||'未命名'; save(); renderGrid(); });
    insTags.addEventListener('blur',()=>{ const a=assets.find(x=>x.id===currentId); if(!a) return; a.tags=insTags.value.split(',').map(s=>s.trim()).filter(Boolean); save(); renderAll(); });
    insFolder.addEventListener('change',()=>{ const a=assets.find(x=>x.id===currentId); if(!a) return; a.folder=insFolder.value; save(); renderAll(); });
    insNotes.addEventListener('blur',()=>{ const a=assets.find(x=>x.id===currentId); if(!a) return; a.notes=insNotes.value; save(); });
    document.getElementById('insDelete').onclick=()=>{ if(!currentId) return; if(!confirm('确定删除该素材？')) return; assets = assets.filter(x=> x.id!==currentId); save(); renderAll(); elInspector.classList.remove('open'); };
    document.getElementById('insStar').onclick=()=>{ const a=assets.find(x=>x.id===currentId); if(!a) return; a.starred=!a.starred; save(); renderGrid(); };

    // ===== Backup =====
    document.getElementById('exportJson').onclick=()=>{
      const blob = new Blob([JSON.stringify({assets,folders},null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='eagle-lite-backup.json'; a.click(); URL.revokeObjectURL(url);
    };
    document.getElementById('importJson').addEventListener('change', (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      f.text().then(t=>{ try{ const obj=JSON.parse(t); if(obj.assets) assets=obj.assets; if(obj.folders) folders=obj.folders; save(); renderAll(); }catch{ alert('导入失败：文件格式不正确'); } });
    });

    // ===== Init =====
    renderAll(); if(!assets.length) elEmpty.style.display='grid';
  </script>
</body>
</html>
